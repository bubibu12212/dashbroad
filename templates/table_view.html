{% extends "layout.html" %}

{% block title %}Data - {{ supplier_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
    <h2 class="display-6 mb-0">Data Supplier: <strong>{{ supplier_name }}</strong></h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i> Kembali ke Pencarian
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Data Rinci per Bulan</h4>
        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
            <i class="fas fa-plus me-1"></i> Tambah Data Baru
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Bulan</th>
                        <th>Total Delivery</th>
                        <th>Item Delay</th>
                        <th>Minus</th>
                        <th>Achievement</th>
                        <th>Target</th>
                        <th>Purchase Amount</th>
                        <th class="text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td>{{ row['CLOSING MONTH'] }}</td>
                        <td>{{ row['TOTAL DELIVERY ITEM'] }}</td>
                        <td>{{ row['ITEM DELAY'] }}</td>
                        <td>{{ row['MINUS'] }}</td>
                        <td class="fw-bold">{{ row['ACHIEVEMENT'] }}</td>
                        <td>{{ row['TARGET DELIVERY'] }}</td>
                        <td>{{ row['Purchase Amount'] }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal"
                                data-row-id="{{ row.row_id }}"
                                data-month="{{ row['CLOSING MONTH'] | replace(' ', '-') }}"
                                data-total-delivery="{{ row['TOTAL DELIVERY ITEM'] }}"
                                data-on-time="{{ row['ON TIME'] }}"
                                data-item-delay="{{ row['ITEM DELAY'] }}"
                                data-minus="{{ row['MINUS'] }}"
                                data-target-delivery="{{ (row['TARGET DELIVERY'] | replace('%', ''))|float }}"
                                data-purchase-amount="{{ (row['Purchase Amount'] | replace('Rp ', '')| replace('.', ''))|int }}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal"
                                data-row-id="{{ row.row_id }}"
                                data-month-display="{{ row['CLOSING MONTH'] }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Data Baru untuk <strong>{{ supplier_name }}</strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_entry', supplier_name=supplier_name) }}" method="post">
                <div class="modal-body">
                    {% include 'form_fields.html' %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-danger">Simpan Data Baru</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="post">
                <div class="modal-body">
                    {% include 'form_fields.html' %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Update Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
             <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Hapus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteForm" method="post">
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menghapus data untuk bulan <strong id="deleteMonthDisplay"></strong>?</p>
                    <p class="text-danger small">Aksi ini tidak dapat dibatalkan.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-danger">Ya, Hapus</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- FUNGSI BARU UNTUK MENGHITUNG ACHIEVEMENT ---
    function calculateAchievement(modal) {
        var totalDeliveryInput = modal.querySelector('.total-delivery-calc');
        var onTimeInput = modal.querySelector('.on-time-calc');
        var achievementOutput = modal.querySelector('.achievement-output-calc');
        if (!totalDeliveryInput || !onTimeInput || !achievementOutput) return;
        var total = parseFloat(totalDeliveryInput.value);
        var onTime = parseFloat(onTimeInput.value);
        if (total > 0 && onTime >= 0) {
            var achievement = (onTime / total) * 100;
            achievementOutput.value = achievement.toFixed(2) + '%';
        } else if (total === 0 && onTime === 0) {
            achievementOutput.value = '100.00%';
        } else {
            achievementOutput.value = '0.00%';
        }
    }

    // --- Fungsi untuk menambahkan listener ke input di dalam modal ---
    function setupCalculator(modal) {
        var totalInput = modal.querySelector('.total-delivery-calc');
        var onTimeInput = modal.querySelector('.on-time-calc');
        if (totalInput && onTimeInput) {
            totalInput.addEventListener('keyup', function() { calculateAchievement(modal); });
            onTimeInput.addEventListener('keyup', function() { calculateAchievement(modal); });
            totalInput.addEventListener('change', function() { calculateAchievement(modal); });
            onTimeInput.addEventListener('change', function() { calculateAchievement(modal); });
        }
    }
    
    // --- Terapkan kalkulator ke Modal "Add Data" ---
    var addModal = document.getElementById('addModal');
    if (addModal) {
        setupCalculator(addModal);
        addModal.addEventListener('hidden.bs.modal', function() {
            var output = addModal.querySelector('.achievement-output-calc');
            if (output) output.value = '';
            addModal.querySelector('form').reset();
        });
    }

    // --- Script untuk Modal Edit (DIMODIFIKASI) ---
    var editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var modalForm = document.getElementById('editForm');
            var modalTitle = editModal.querySelector('.modal-title');
            
            // Mengambil data dari tombol (sesuai cara lama file ini)
            var rowId = button.getAttribute('data-row-id');
            var month = button.getAttribute('data-month');
            var totalDelivery = button.getAttribute('data-total-delivery');
            var onTime = button.getAttribute('data-on-time');
            var itemDelay = button.getAttribute('data-item-delay');
            var minus = button.getAttribute('data-minus');
            var targetDelivery = button.getAttribute('data-target-delivery');
            var purchaseAmount = button.getAttribute('data-purchase-amount');

            // Logika untuk konversi bulan
            const monthMap = { "Januari": "01", "Februari": "02", "Maret": "03", "April": "04", "Mei": "05", "Juni": "06", "Juli": "07", "Agustus": "08", "September": "09", "Oktober": "10", "November": "11", "Desember": "12" };
            const [monthName, year] = month.split('-');
            const monthValue = `${year}-${monthMap[monthName]}`;

            modalTitle.textContent = 'Edit Data untuk Bulan ' + monthName + ' ' + year;
            
            // --- PERBAIKAN BUG: Form action di file ini salah ---
            // Seharusnya '/data/edit/' sesuai app.py, bukan '/edit/'
            modalForm.action = '/data/edit/' + rowId;
            
            // Mengisi form
            modalForm.querySelector('[name="month"]').value = monthValue;
            modalForm.querySelector('[name="total_delivery"]').value = totalDelivery;
            modalForm.querySelector('[name="on_time"]').value = onTime;
            // 'item_delay' tidak ada di form_fields.html, jadi kita abaikan
            modalForm.querySelector('[name="minus"]').value = minus;
            modalForm.querySelector('[name_all="target_delivery"]').value = targetDelivery;
            modalForm.querySelector('[name="purchase_amount"]').value = purchaseAmount;
            
            // Terapkan kalkulator ke modal edit
            setupCalculator(editModal);
            // Langsung hitung nilai achievement saat modal dibuka
            calculateAchievement(editModal);
        });
    }

    // --- Script untuk Hapus (DIMODIFIKASI) ---
    var deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var rowId = button.getAttribute('data-row-id');
            var monthDisplay = button.getAttribute('data-month-display');
            
            var modalForm = document.getElementById('deleteForm');
            
            // --- PERBAIKAN BUG: Form action di file ini salah ---
            // Seharusnya '/data/delete/' sesuai app.py, bukan '/delete/'
            modalForm.action = '/data/delete/' + rowId;
            
            var monthDisplaySpan = document.getElementById('deleteMonthDisplay');
            monthDisplaySpan.textContent = monthDisplay;
        });
    }
});
</script>
{% endblock %}